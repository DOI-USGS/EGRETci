<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{Introduction to EGRET Confidence Intervals}
-->

```{r setup, include=FALSE}
library(xtable)
options(continue=" ")
options(width=60)
library(knitr)
library(EGRET)
library(EGRETci)

```

# Introduction to EGRET Confidence Intervals
By Robert M. Hirsch, Laura A. De Cicco

This package **EGRETci** is an early test version of the package that will encompass the various approaches to uncertainty estimation associated with trend analysis for the **EGRET** package.  The various functions included here are all discussed in the draft manuscript _A bootstrap method for estimating uncertainty of water quality trends_ by Hirsch, Archfield, and De Cicco (draft version of March 9, 2015).  The present version of the **EGRETci** package is designed for interactive use only, but later versions will describe how batch workflows can be created.  Also, the current version can only do analysis of trends for water years, but later versions will allow it to evaluate any group of months (i.e. any 'Period of Analysis' to use the term in the EGRET package).  The **EGRETci** package is designed to carry out three specific types of tasks.
    
    
1)  Evaluate a water quality trend over a specific span of years and produce a variety of tabular results.  This is done with a short workflow involving four functions: `trendSetUp`, `setPA`, `setForBoot`, and `wBT`.  The results come in two forms: 1) console output, which shows the bootstrap replicate process as it is underway and provides text output of results, and 2) a set of outputs in a named list called eBoot.  The contents of eBoot are described below.


2)  Prepare histograms of values for the trend magnitudes, expressed in percent, for flow-normalized concentration and flow-normalized flux.  This is done with the function `plotHistogramTrend`.  It depends on outputs contained in eBoot.


3)  Plot confidence bands around the computed trends in flow-normalized concentration and flow-normalized flux.  This is done using a single interactive function called `ciCalculations` and then, using the output from that function running two functions that produce the confidence band graphics for concentration and flux respectively (`plotConcHistBoot`, and `plotFluxHistBoot`).

The following table provides definitions of the four data frames that constitute the named list **eBoot**

|Data Frame |Column | Definition |
|:----|:----|:----|
|bootOut|  rejectC  |Reject Ho, (no trend in concentration), TRUE or FALSE |  
|| pValC | p-value for no trend in concentration | 
|| estC | standard WRTDS estimate of change from starting year to ending year in mg/L | 
|| lowC | Lower confidence limit (90%) on concentration trend | 
|| upC | Upper confidence limit (90%) on concentration trend | 
|| lowC50 | Lower confidence limit (50%) on concentration trend | 
|| upC50 | Upper confidence limit (50%) on concentration trend |
|| lowC95 | Lower confidence limit (95%) on concentration trend | 
|| upC95 | Upper confidence limit (95%) on concentration trend | 
|| likeCUp | Likelihood that trend in concentration is upwards | 
|| likeCDown | Likelihood that trend in concentration is downwards |
|| rejectF | Reject Ho, (no trend in flux), TRUE or FALSE | 
|| pValF | p-value for no trend in flux |
|| estF | estimate of change from starting year to ending year, in 10^6^ kg/yr |
|| lowF | Lower confidence limit (90%) on flux trend |
|| upF | Upper confidence limit (90%) on flux trend |
|| lowF50 | Lower confidence limit (50%) on flux trend |
|| upF50 | Upper confidence limit (50%) on flux trend |
|| lowF95 | Lower confidence limit (95%) on flux trend |
|| upF95 | Upper confidence limit (95%) on flux trend |
|| likeFUp | Likelihood that trend in flux is upwards |
|| likeFDown | Likelihood that trend in flux is downwards |
|| baseConc | Estimated mean flow-normalized concentration for first year, in mg/L |
|| baseFlux | Estimated mean flow-normalized flux for start year, in 10^6^ kg/yr |
|| iBoot | The actual number of bootstrap replicates used |
|wordsOut | | a vector of four character variables (self explanatory) |
|xConc | | a vector of length iBoot, of the change in flow normalized concentration computed by each bootstrap replicate (mg/L) |
|xFlux | | a vector of length iBoot, of the change in flow normalized flux computed by each bootstrap replicate (10^6^ kg/yr) |


There is also a data frame called caseSetUp (created with the `trendSetUp` function), which contains a number of important parameters that define the way that the test was implemented.  They are presented here.

|Column |Definition |
|:----|:----|
|year1 | the water year that is the start of the trend period (an integer) | 
|yearData1 | the water year that is the start of the data set (an integer) | 
|year2 | the water year that is the end of the trend period (an integer) |
|yearData2 | the water year that is the end of the data set (an integer) |
|numSamples | number of samples in eList$Sample |
|nBoot | maximum number of replicates (called Mmax in paper) |
|bootBreak | minimum number of replicates (called Mmin in paper) |
|blockLength | length of blocks for bootstrap (called B in the paper) |
|confStop | 1 - alphap, the width of the confidence interval used in adaptive stopping rule (default alphap=0.3 so confStop=0.7) |

The following is an example workflow for an interactive run of the WBT (WRTDS Bootstrap Test), using the example data set in Choptank_eList.

```{r eval=FALSE, echo=TRUE  } 
library(EGRET)
library(EGRETci)
eList <- Choptank_eList

#Interactive function to set up trend analysis:
caseSetUp <- trendSetUp(eList)
eList <- setForBoot(eList, caseSetUp)

eBoot <- wBT(eList,caseSetUp, 
             saveOutput = TRUE, fileName = "outputText.txt")

#Interactive save output function:
saveEGRETci(eList, eBoot)


```

The output in `outputText.txt` is:
```
 Choptank River    Inorganic nitrogen (nitrate and nitrite)

  Bootstrap process, for change from Water Year 1985 to Water Year 2005
                   data set runs from WaterYear 1980 to Water Year 2011
  Bootstrap block length in days 200
  bootBreak is 39  confStop is 0.7

 WRTDS estimated concentration change is   0.328  mg/L
 WRTDS estimated flux change is          0.03148  10^6 kg/yr

Should we reject Ho that Flow Normalized Concentration Trend = 0 ? Reject Ho
 best estimate is   0.328 mg/L
  Lower and Upper 90% CIs    0.237    0.380
 also 95% CIs    0.206    0.387 
 and 50% CIs    0.302    0.350
 approximate two-sided p-value for Conc     0.025
* Note p-value should be considered to be < stated value
 Likelihood that Flow Normalized Concentration is trending up = 0.988 is trending down = 0.0125

Should we reject Ho that Flow Normalized Flux Trend = 0 ? Reject Ho
 best estimate is  0.03148 10^6 kg/year
  Lower and Upper 90% CIs   0.0218   0.0418
 also 95% CIs   0.0192   0.0422 
 and 50% CIs   0.0276   0.0368
 approximate two-sided p-value for Flux     0.025
* Note p-value should be considered to be < stated value
 Likelihood that Flow Normalized Flux is trending up = 0.988 is trending down = 0.0125

 Upward trend in concentration is highly likely 
 Upward trend in flux is highly likely
 Downward trend in concentration is highly unlikely 
 Downward trend in flux is highly unlikely

```

## Histograms

These functions plot histograms of all of the trend slopes from the full set of replicates created by wBT.  These slopes are stored in the eBoot list.  The first example workflow can be used to plot the two histograms: one for trends in Flow Normalized Concentration and one for Flow Normalized Flux.  

A comment about the final argument in these functions: The default is xSeq = seq(-100,100,10).  This means that the bins for the histogram will run from -100 to +100 in steps of 10 (the units are percentage change).  This will almost certainly be to broad a set of bins, but the first run, with the xSeq left at its devault values (meaning you can just leave it out of the argument list) will give you an idea of the true range that you need to consider.  Then, run it again with a much tighter range that still includes all of the replicate trends.  For example, suppose we see that the replicates seen in the first plot run tell us this: the lowest value is between -30 and -20 and the highest value is between 40 and 50, then we give the command again we should say xSeq = seq(-30,50,10).  If it turns out that all the values are much closer to zero we might use something like xSeq = seq(-15,5,5) so the bins are a width of 5 rather than 10.  It is also a good idea to have the full width of the histogram include zero.  So in the case where the values were all in the range of +20 to +70, you might use something like xSeq = seq(0,70,10).  

Here is an example workflow where the analyst has already determined what a good xSeq argument might be.

```{r, fig.height=6, fig.width=6}
library(EGRET)
library(EGRETci)

# Example data included in package:
eList <- Choptank_eList # Example data from EGRET package
eBoot <- Choptank_eBoot
caseSetUp <- Choptank_caseSetUp

#Concentration:
plotHistogramTrend(eBoot, caseSetUp, eList, 
                   flux=FALSE, xSeq = seq(-20,60,5))

#Flux
plotHistogramTrend(eBoot, caseSetUp, eList,
                   flux=TRUE, xSeq = seq(-20,60,5))

```

Alternatively, the two plots can be shown side-by-side using a workflow like this.

Use the par function to set up both functions to plot side-by-side:

```{r , histExampleCombo, fig.width=7, fig.height=4}
par(mfrow=c(1,2))
plotHistogramTrend(eBoot, caseSetUp, eList, flux=FALSE,
                   printTitle=FALSE, ylim=c(0,0.07), xSeq=seq(-10,70,10))
plotHistogramTrend(eBoot, caseSetUp, eList, flux=TRUE,
                   printTitle=FALSE, ylim=c(0,0.07), xSeq=seq(-10,70,10))
# To return to 1 row, 1 column:
par(mfrow=c(1,1))                   
```

## Confidence Bands

There are two versions of the workflow for confidence bands.  The first is very simple, but results in the use of a very large amount of computer time (easily an hour).  It is best done in the Terminal or some other window, rather than in the console, because it will make it impossible for other work in R to take place if it is done in the console.  The second way it can be done is using parallel computing in R.  A script for that purpose is provided.  It does require three extra packages be installed (**foreach**, **doParallel**, and **iterators**).  It is also best to run this in the terminal, because if it is run in the console, no other work can be done while it is running.  Regardless of the way that the computations are done, they will result in the creation of a small data frame called CIAnnualResults.  Once that data frame exists, the graphics can be produced using the functions `plotConcHistBoot` and `plotFluxHistBoot`.  In either case they only require two arguments (eList and CIAnnualResults).  However, the user can specify a number of other arguments.  These other arguments are the same ones used in the `plotConcHist` and `plotFluxHist` functions in the base **EGRET** package.


Base-R workflow for confidence bands on model results:

```{r, eval=FALSE}
library(EGRET)
library(EGRETci)

eList <- Choptank_eList

CIAnnualResults <- ciCalculations(eList)

save(eList,CIAnnualResults, file="CIAnnualResults.RData")


```


Taking advantage of the foreach package to do parallel computing:

```{r, eval=FALSE}
library(foreach)
library(doParallel)
library(iterators)
library(EGRET)
library(EGRETci)

eList <- Choptank_eList

nBoot <- 100
blockLength <- 200
coreOut <- 1 #Number of cores to leave out of processing tasks

widthCI <- 90
ciLower <- (50-(widthCI/2))/100
ciUpper <- (50+(widthCI/2))/100
probs <- c(ciLower,ciUpper)

nCores <- detectCores() - coreOut
cl <- makeCluster(nCores)
registerDoParallel(cl)
repAnnual <- foreach(n = 1:nBoot,.packages=c('EGRETci')) %dopar% {
   annualResults <- bootAnnual(eList, blockLength)  
}
stopCluster(cl)               

# save(repAnnualResults, file="repAnnual.RData")

CIAnnualResults <- ciBands(eList, repAnnual, probs)
save(eList,CIAnnualResults, file="CIAnnualResults.RData")

```

Regardless of the way you implemented ciCalculations, the following concentration and flux plots can then be generated from the CIAnnualResults data.  If they aren't already loaded, you will need to load the file CIAnnualResults.RData, which contains eList, and CIAnnualResults.

```{r, fig.height=5, fig.width=7}
eList <- Choptank_eList

CIAnnualResults <- Choptank_CIAnnualResults

plotConcHistBoot(eList, CIAnnualResults)

plotFluxHistBoot(eList, CIAnnualResults)

```
