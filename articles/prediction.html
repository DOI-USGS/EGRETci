<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="EGRETci">
<title>Graphics for Prediction Intervals • EGRETci</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Graphics for Prediction Intervals">
<meta property="og:description" content="EGRETci">
<meta property="og:image" content="http://usgs-r.github.io/EGRETci/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-53797708-7"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53797708-7');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://www.usgs.gov/" class="external-link"><img src="logo.png" id="logo" alt="Home" style="padding: 0px 50px 0px 0px;"></a>
    <a class="navbar-brand me-2" href="../index.html">EGRETci</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.0.4.0002</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/EGRETci.html">Introduction</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Function Help Pages</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/Enhancements.html">Enhancements</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/prediction.html">WRTDS Kalman Prediction Intervals</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://code.usgs.gov/water/EGRETci">
    <span class="fa fa-gitlab fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Graphics for Prediction Intervals</h1>
                        <h4 data-toc-skip class="author">Robert M.
Hirsch</h4>
            
            <h4 data-toc-skip class="date">3/22/2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/USGS-R/EGRETci/blob/HEAD/vignettes/prediction.Rmd" class="external-link"><code>vignettes/prediction.Rmd</code></a></small>
      <div class="d-none name"><code>prediction.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This script provides a set of examples of how to use WRTDS_Kalman
outputs to characterize the uncertainty in an estimated record of
concentration or flux (mostly we will deal with flux here). The workflow
that takes place before this point consists of the following steps.</p>
<ol style="list-style-type: decimal">
<li><p>eList is created and WRTDS model is estimated. Note here that it
is irrelevant whether we use Stationary Flow Normalization or
Generalized Flow Normalization. The simplest thing to do is estimate the
model with <code>modelEstimation</code>. If the wall feature is desired,
then this step should be done with <code>runSeries</code>.</p></li>
<li><p>The WRTDS_Kalman estimates need to be computed. This is done with
the command:</p></li>
</ol>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pubs.usgs.gov/tm/04/a10/" class="external-link">EGRET</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://code.usgs.gov/water/EGRETci" class="external-link">EGRETci</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">eListK</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"Pinehurst_eListK.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">eListK</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/EGRET/man/wrtdsK.html" class="external-link">WRTDSKalman</a></span><span class="op">(</span><span class="va">eList</span><span class="op">)</span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Then we want to create a large number of bootstrap replicates of the
daily record of concentration and flux. We do that with the command like
this:</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dailyBootOut</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kalman.html">genDailyBoot</a></span><span class="op">(</span><span class="va">eListK</span>, </span>
<span>                             nBoot <span class="op">=</span> <span class="fl">25</span>, nKalman <span class="op">=</span> <span class="fl">20</span>, rho <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span></span></code></pre></div>
<ul>
<li>nBoot is the number of bootstrap replicates that is run, each one is
used to estimate the WRTDS model (we can think of this as the estimation
error)</li>
<li>nKalman is the number of individual traces of concentration (and
flux) that is generated from each of these WRTDS models (we can think of
this as the stochastic variability of the process)</li>
<li>rho is the autoregressive lag one day correlation coefficient that
we assume (default is 0.9)</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Now we are ready to look at uncertainty at time scale of Annual,
Monthly, and Daily. We will also look at the uncertainty of the
cumulative flux record.</li>
</ol>
</div>
<div class="section level2">
<h2 id="setting-up-the-data-and-running-the-annual-prediction-intervals">Setting up the data and running the Annual Prediction Intervals<a class="anchor" aria-label="anchor" href="#setting-up-the-data-and-running-the-annual-prediction-intervals"></a>
</h2>
<p>We start by creating the very large matrix called dailyBootOut. Each
row of this matrix is a day in our record. There must be a perfect match
between the rows of eList$Daily and the rows of dailyBootOut. The
various calculations we will do here need to get their date information
and their discharge information from eList$Daily. Each column of this
matrix is an individual replicate of the time series of flux values. In
the case we are running here, where nBoot = 25 and nKalman = 20, the
number of columns is 25*20 = 500.</p>
<p>In this case where we are looking for annual values the process will
be to aggregate each of these daily records into annual records and then
look at the distribution of flux values for each year of the record.
This distribution for each year, will provide us with the prediction
interval, for that year.</p>
<p>Throughout this example we will do everything based on 90% prediction
intervals. That means that we are estimating that there is a 0.05
probability that the true value lies above the interval, and a 0.05
probability that the true value lies below the interval, and a 0.9
probability that the true value lies within the interval. If we wanted
to go for a higher prediction interval, say a 95% prediction interval or
a 98% prediction interval we would need to greatly increase the number
of replicates run, which would greatly increase the computational and
storage burden.</p>
<p>Notice that we need to use the eListK data frame to find our
WRTDSKalman estimate for each time step. This will give us the expected
value of flux. We could, in place of the expected value, use the median
from the 500 replicates.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># this next line is what you would run if you needed to create dailyBootOut</span></span>
<span><span class="co"># dailyBootOut &lt;- genDailyBoot(eList, nBoot = 25, nKalman = 20, rho = 0.9)</span></span>
<span><span class="va">annPct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeAnnualPI.html">makeAnnualPI</a></span><span class="op">(</span><span class="va">dailyBootOut</span>, <span class="va">eListK</span><span class="op">)</span></span>
<span></span>
<span><span class="va">yMax</span> <span class="op">&lt;-</span> <span class="fl">1.1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">annPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p95</span><span class="op">)</span></span>
<span><span class="va">nYears</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">annPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p95</span><span class="op">)</span></span>
<span><span class="va">AnnualResults</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/EGRET/man/setupYears.html" class="external-link">setupYears</a></span><span class="op">(</span><span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">)</span></span>
<span><span class="va">kFlux</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">AnnualResults</span><span class="op">$</span><span class="va">DecYear</span>,<span class="va">AnnualResults</span><span class="op">$</span><span class="va">GenFlux</span><span class="op">)</span></span>
<span><span class="va">title</span> <span class="op">&lt;-</span> <span class="st">"South Fork Coeur d'Alene River near Pinehurst, ID\nAnnual Total Phosphorus Flux\nWith 90% Prediction Intervals"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">kFlux</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">kFlux</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">yMax</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>,main <span class="op">=</span> <span class="va">title</span>, xlab <span class="op">=</span> <span class="st">"Year"</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"Annual Mean Flux, in kg per day"</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex <span class="op">=</span> <span class="fl">0.7</span>, las <span class="op">=</span> <span class="fl">1</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">3</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">4</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span> <span class="va">nYears</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">annPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">DecYear</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">annPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p5</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">annPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p95</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, </span>
<span>        col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>So the black dot is our best estimate of the flux for that year. The
red bar is our 90% prediction interval.</p>
<p>A note about units throughout this discussion. We are always
presenting flux here as an average rate kg/day. We could have presented
them as a total flux for the year, in which case the quantities could
have all been multiplied by 365.25 and the label on the y-axis changed
to “Annual Flux, in kg”. Or we could multiply each flux value by
(365.25/1000) and change the label to “Annual Flux, in metric tons”.</p>
<p>Note that the prediction intervals are narrow in the low flux years
and very wide in the high flux years, but the relationship between the
mean value and the width of the interval isn’t a simple relationship
because a lot depends on how well the samples collected around that year
characterize the whole relationship between concentration and time,
discharge, and season.</p>
<p>We could, if we wanted to, show this same result on a log scale.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">yMax</span> <span class="op">&lt;-</span> <span class="fl">1.15</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">annPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p95</span><span class="op">)</span></span>
<span><span class="va">yMin</span> <span class="op">&lt;-</span> <span class="fl">0.85</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">annPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p5</span><span class="op">)</span></span>
<span><span class="va">ylim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yMin</span>, <span class="va">yMax</span><span class="op">)</span></span>
<span><span class="va">nYears</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">annPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p95</span><span class="op">)</span></span>
<span><span class="va">AnnualResults</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/EGRET/man/setupYears.html" class="external-link">setupYears</a></span><span class="op">(</span><span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">)</span></span>
<span><span class="va">kFlux</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">AnnualResults</span><span class="op">$</span><span class="va">DecYear</span>,<span class="va">AnnualResults</span><span class="op">$</span><span class="va">GenFlux</span><span class="op">)</span></span>
<span><span class="va">title</span> <span class="op">&lt;-</span> <span class="st">"South Fork Coeur d'Alene River near Pinehurst, ID\nAnnual Total Phosphorus Flux\nWith 90% Prediction Intervals"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">kFlux</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">kFlux</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,ylim <span class="op">=</span> <span class="va">ylim</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>,main <span class="op">=</span> <span class="va">title</span>, xlab <span class="op">=</span> <span class="st">"Year"</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"Annual Mean Flux, in kg per day"</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex <span class="op">=</span> <span class="fl">0.7</span>, las <span class="op">=</span> <span class="fl">1</span>, tck <span class="op">=</span> <span class="fl">0.02</span>, log <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">3</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">4</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span> <span class="va">nYears</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">annPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">DecYear</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">annPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p5</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">annPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p95</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, </span>
<span>        col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="monthly-prediction-intervals">Monthly prediction intervals<a class="anchor" aria-label="anchor" href="#monthly-prediction-intervals"></a>
</h2>
<p>The process is very similar except that we will only show the output
here on a log scale graphic (there are such large differences between
the largest flux months and the smallest flux months). Here again, these
are flux rates (in kg/day), the output could be changed to a total mass
for each month, by multiplying each of these values by the number of
days in that month.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MonthlyResults</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/EGRET/man/calculateMonthlyResults.html" class="external-link">calculateMonthlyResults</a></span><span class="op">(</span><span class="va">eListK</span><span class="op">)</span></span>
<span><span class="va">kFluxMonth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">MonthlyResults</span><span class="op">$</span><span class="va">DecYear</span>,<span class="va">MonthlyResults</span><span class="op">$</span><span class="va">GenFlux</span><span class="op">)</span></span>
<span><span class="va">nMonths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">MonthlyResults</span><span class="op">$</span><span class="va">DecYear</span><span class="op">)</span></span>
<span><span class="va">monthPct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeMonthPI.html">makeMonthPI</a></span><span class="op">(</span><span class="va">dailyBootOut</span>, <span class="va">eListK</span><span class="op">)</span></span>
<span><span class="va">yMaxMonth</span> <span class="op">&lt;-</span> <span class="fl">1.15</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">monthPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p95</span><span class="op">)</span></span>
<span><span class="va">yMinMonth</span> <span class="op">&lt;-</span> <span class="fl">0.85</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">monthPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p5</span><span class="op">)</span></span>
<span><span class="va">title</span> <span class="op">&lt;-</span> <span class="st">"South Fork Coeur d'Alene River near Pinehurst, ID\nMonthly Total Phosphorus Flux\nWith 90% Prediction Intervals"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">kFluxMonth</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">kFluxMonth</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yMinMonth</span>,<span class="va">yMaxMonth</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>,main <span class="op">=</span> <span class="va">title</span>, xlab <span class="op">=</span> <span class="st">"Year"</span>, las <span class="op">=</span> <span class="fl">1</span>, tck <span class="op">=</span> <span class="fl">0.02</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Monthly Mean Flux, in kg per day"</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, log <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">3</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">4</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span> <span class="va">nMonths</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">MonthlyResults</span><span class="op">$</span><span class="va">DecYear</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">monthPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p5</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">monthPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p95</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, </span>
<span>        col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="daily-prediction-intervals">Daily prediction intervals<a class="anchor" aria-label="anchor" href="#daily-prediction-intervals"></a>
</h2>
<p>The process here is similar, except here we don’t have to aggregate
up to months or year. The number of days is so large that showing a
single graph of the prediction intervals for each day is just too
crowded to show. What we are showing here is just a time slice of less
than one year. This the choice of time periods to show is just
manipulated by changing the xlim argument in the plot command.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kFluxDay</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">GenFlux</span><span class="op">)</span></span>
<span><span class="va">nDays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">DecYear</span><span class="op">)</span></span>
<span><span class="va">dayPct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeDailyPI.html">makeDailyPI</a></span><span class="op">(</span><span class="va">dailyBootOut</span>, <span class="va">eListK</span><span class="op">)</span></span>
<span><span class="va">yMaxDay</span> <span class="op">&lt;-</span> <span class="fl">1.15</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dayPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p95</span><span class="op">)</span></span>
<span><span class="va">yMinDay</span> <span class="op">&lt;-</span> <span class="fl">0.85</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dayPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p5</span><span class="op">)</span></span>
<span><span class="va">xlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1996</span>, <span class="fl">1996.6</span><span class="op">)</span></span>
<span><span class="va">title</span> <span class="op">&lt;-</span> <span class="st">"South Fork Coeur d'Alene River near Pinehurst, ID\nDaily Total Phosphorus Flux\nWith 90% Prediction Intervals"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">kFluxDay</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">kFluxDay</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yMinDay</span>,<span class="va">yMaxDay</span><span class="op">)</span>, xlim <span class="op">=</span> <span class="va">xlim</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>,main <span class="op">=</span> <span class="va">title</span>, xlab <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Daily Flux, in kg per day"</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, log <span class="op">=</span> <span class="st">"y"</span>, las <span class="op">=</span> <span class="fl">1</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">3</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">4</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span> <span class="va">nDays</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">kFluxDay</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dayPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p5</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">dayPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p95</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, </span>
<span>        col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>A feature of this plot that is worth noting is that the prediction
intervals narrow at certain points. Those are dates when one or more
samples have been collected. For example, there is a day just 3 days
from the end of the period shown when there the prediction interval has
a width of zero. That is the sampled day 1996-08-13. About a month
before that 1996-07-15 (which appears around 1996.54) we see the
prediction interval being very narrow but it hasn’t shrunk to zero width
and that because this sample value was reported as &lt;0.01 mg/L, so
even though we have a sample that day there is still some uncertainty.
Of course, these days with prediction intervals of zero width
demonstrate an oversimplification in the method we are using here. The
sample value of concentration multiplied by the discharge for that day
is not a perfect estimate of flux. There is, no doubt, some within day
variation in concentration and there is also some random error in the
sample collection and sample analysis in the laboratory. One could make
this analysis more complex and add these other features to it but we
view this oversimplification as being a reasonable way to proceed. It
does help one see when estimates are likely to be fairly poor versus
when they are likely to be fairly good.</p>
<p>We can look at another time slice of the same length at a more recent
time. Note that the scales on this plot is the same as the scale on the
previous plot.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2017</span>, <span class="fl">2017.6</span><span class="op">)</span></span>
<span><span class="va">title</span> <span class="op">&lt;-</span> <span class="st">"South Fork Coeur d'Alene River near Pinehurst, ID\nDaily Total Phosphorus Flux\nWith 90% Prediction Intervals"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">kFluxDay</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">kFluxDay</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yMinDay</span>,<span class="va">yMaxDay</span><span class="op">)</span>, xlim <span class="op">=</span> <span class="va">xlim</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>,main <span class="op">=</span> <span class="va">title</span>, xlab <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Daily Flux, in kg per day"</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, log <span class="op">=</span> <span class="st">"y"</span>, las <span class="op">=</span> <span class="fl">1</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">3</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">4</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span> <span class="va">nDays</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">kFluxDay</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dayPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p5</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">dayPct</span><span class="op">$</span><span class="va">flux</span><span class="op">$</span><span class="va">p95</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, </span>
<span>        col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="looking-at-the-daily-record-from-a-concentration-perspective">Looking at the daily record from a concentration perspective<a class="anchor" aria-label="anchor" href="#looking-at-the-daily-record-from-a-concentration-perspective"></a>
</h2>
<p>Up to this point we have just been looking at flux, and generally
that is where WRTDSKalman will likely be most useful, but there can be
insights that it can provide about frequencies at which concentration
might exceed some kind of water quality standard (either an aquatic life
standard, a recreational water standard, or a drinking water source
standard). I’ll use the same data set and just pretend there is a
standard we want to use as a benchmark, at 0.1 mg/L. In the simplest
terms we want to get an idea if there are some long term changes in how
frequently concentration might be exceeding the benchmark. The graphics
shown here should be thought of as indicative of changing conditions but
should not be viewed as a rigorous quantitative result. I believe there
are some ways to go about such analyses but that’s beyond the scope of
these discussions. For an example of a case where WRTDS was used to try
to quantify trends in frequency of exceedances see (Corsi et al.,
2015)[<a href="https://doi.org/10.1016/j.scitotenv.2014.12.012" class="external-link uri">https://doi.org/10.1016/j.scitotenv.2014.12.012</a>]. The
method used in that paper has not yet been turned into portable R code
and subjected to testing, but it probably could be by an able graduate
student.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2000</span>,<span class="fl">2020</span><span class="op">)</span></span>
<span><span class="va">kConcDay</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">GenConc</span><span class="op">)</span></span>
<span><span class="va">yMaxDay</span> <span class="op">&lt;-</span> <span class="fl">1.15</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dayPct</span><span class="op">$</span><span class="va">conc</span><span class="op">$</span><span class="va">p95</span><span class="op">)</span></span>
<span><span class="va">yMinDay</span> <span class="op">&lt;-</span> <span class="fl">0.85</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dayPct</span><span class="op">$</span><span class="va">conc</span><span class="op">$</span><span class="va">p5</span><span class="op">)</span></span>
<span><span class="va">title</span> <span class="op">&lt;-</span> <span class="st">"South Fork Coeur d'Alene River near Pinehurst, ID\nDaily Total Phosphorus Concentration\nWith 90% Prediction Intervals (pretend there was a standard of 0.1 mg/L)"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">kConcDay</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">kConcDay</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yMinDay</span>,<span class="va">yMaxDay</span><span class="op">)</span>, xlim <span class="op">=</span> <span class="va">xlim</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>,main <span class="op">=</span> <span class="va">title</span>, xlab <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Concentration, in mg/L"</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex <span class="op">=</span> <span class="fl">0.2</span>, log <span class="op">=</span> <span class="st">"y"</span>, xaxs <span class="op">=</span> <span class="st">"i"</span>, las <span class="op">=</span> <span class="fl">1</span>, cex.main <span class="op">=</span> <span class="fl">0.7</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">3</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">4</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span> <span class="va">nDays</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">kConcDay</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dayPct</span><span class="op">$</span><span class="va">conc</span><span class="op">$</span><span class="va">p5</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">dayPct</span><span class="op">$</span><span class="va">conc</span><span class="op">$</span><span class="va">p95</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, </span>
<span>        col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0.1</span>, col <span class="op">=</span> <span class="st">"green"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>From this graph lets pose a question. Let’s define something we’ll
call a “potentially problematic day” (PPD) as being a day when we think
that the probability that the day exceeded the standard of 0.1 mg/L is
greater than 0.05. Visually, a PPD is any day when the red vertical line
sticks up above the 0.1 mg/L standard. I think we can say that the
frequency of PPDs has been decreasing over time. Good news! The wording
and the strict probabalistic meaning is imperfect at this point, but I
think the concept is worth developing.</p>
</div>
<div class="section level2">
<h2 id="cumulative-loading">Cumulative loading<a class="anchor" aria-label="anchor" href="#cumulative-loading"></a>
</h2>
<p>When we are dealing with the subject of inputs and/or outputs of some
material to (or from) a reservoir, lake, or even a river reach
(including its riparian zone) it is useful to think about the cumulative
fluxes. That is, we want to add up all the fluxes day by day and see the
cumulative amounts grow over time. What we often see when we do this is
a clear indication that for constituents like TP which mostly move
through the system at times of very high discharge, we see a cumulative
curve that is gently sloping upwards, punctuated by a series of vertical
steps representing the brief periods of very high discharge.</p>
<p>What we will show here is first, our best estimate of the cumulative
flux which we derive from the WRTDSKalman estimate (with no
consideration of uncertainty). Then we can add to that a number of
equally likely traces of cumulative flux, using some of the many
replicates that we have stored in dailyBootOut. There were 500 of these
equally likely traces in dailyBootOut (each trace is a column of the
matrix) and that would look like just a mass of ink on the screen, so to
make it more understandable we will plot every tenth trace (trace 1,
trace 11, trace 21, …trace 491).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nIter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dailyBootOut</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">nDays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dailyBootOut</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dailyBootSum</span> <span class="op">&lt;-</span> <span class="va">dailyBootOut</span></span>
<span><span class="va">title</span> <span class="op">&lt;-</span> <span class="st">"South Fork Coeur d'Alene River near Pinehurst, ID\nCumulative Daily Total Phosphorus Flux\nShowing the best estimate from WRTDSKalman"</span></span>
<span><span class="va">cumulative</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">GenFlux</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nLines</span> <span class="op">&lt;-</span> <span class="va">nIter</span> <span class="op">/</span> <span class="fl">10</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span> <span class="va">nIter</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">dailyBootSum</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">dailyBootOut</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">yMax</span> <span class="op">&lt;-</span> <span class="fl">1.1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dailyBootSum</span><span class="op">[</span><span class="va">nDays</span>,<span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># first we will look at the WRTDSKalman estimate alone</span></span>
<span></span>
<span><span class="co"># we divide all the values by 1000 to get to metric tons</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">cumulative</span><span class="op">/</span><span class="fl">1000</span>, </span>
<span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">yMax</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, </span>
<span>     main <span class="op">=</span> <span class="va">title</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Cumulative flux, in metric tons"</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"Year"</span>,type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span>, las <span class="op">=</span> <span class="fl">1</span>, tck <span class="op">=</span> <span class="fl">0.02</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">3</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">4</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># now showing the random iterations </span></span>
<span><span class="va">title</span> <span class="op">&lt;-</span> <span class="st">"South Fork Coeur d'Alene River near Pinehurst, ID\nCumulative Daily Total Phosphorus Flux\nonly showing one tenth of the iterations"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">dailyBootSum</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">/</span><span class="fl">1000</span>, </span>
<span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">yMax</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, main <span class="op">=</span> <span class="va">title</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Cumulative flux, in metric tons"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Year"</span>,type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, las <span class="op">=</span> <span class="fl">1</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">3</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">4</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span> <span class="va">nLines</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">j</span> <span class="op">&lt;-</span> <span class="va">k</span> <span class="op">*</span> <span class="fl">10</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">dailyBootSum</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span><span class="op">/</span><span class="fl">1000</span>, </span>
<span>           type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-10-2.png" width="700"></p>
<p>What we see in either of these is that we have long periods of fairly
gradual increase in the cumulative flux, punctuated by some very abrupt
increases during high flow events such as happened in 1996. If we look
at the one with 50 iterations we can see that these traces stay pretty
close together and over the roughly 30 years to total range of the
cumulative flux runs from about 550 metric tons to about 640 metric tons
of phosphorus passing this monitoring site. The next phase of analysis
(which won’t be covered in this document) would involve doing the exact
same kind of analysis at the next monitoring site downstream, creating
500 possible iterations of that record. Then, if we wanted to examine
the record of gains and losses of TP in the reach between the two sites,
we could randomly pair up iterations from the upstream site with
iterations from the downstream site, and take the difference of the two
cumulative records. Then we could look at that cumulative record of
differences and see a distribution of gains and/or losses in the reach.
But, that’s for another day.</p>
</div>
<div class="section level2">
<h2 id="prediction-intervals-on-the-cumulative-flux">Prediction intervals on the cumulative flux<a class="anchor" aria-label="anchor" href="#prediction-intervals-on-the-cumulative-flux"></a>
</h2>
<p>What we are going to do here is look at prediction intervals on the
cumulative flux curve for every day of the record. We are actually going
to create three lines. One in black that represents the median of the
distribution for that day. That means that our model tells us that there
is a 50% chance that the true cumulative flux on that day falls above
the black line (and 50% chance that it falls below the black line). Then
in red will be the 5% and 95% limits. That means there is a 5% chance
that the true cumulative flux lies below the lower red line and a 5%
chance that the true cumulative flux lies above the upper red line, and
of course, a 90% chance that the true cumulative flux lies between the
two red lines on any given day. Note that we are making inferences about
where the true value is on any given day. This graph does not tell us
anything about the probability that the true trace will fall entirely
inside the red lines. The probability that the true cumulative flux
(which we don’t actually know) would sometime fall outside of the two
red curves is almost certainly a good deal larger than 10%, but we have
no way of knowing what that might be.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nIter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dailyBootOut</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">nDays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dailyBootOut</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dailyLow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">nDays</span><span class="op">)</span></span>
<span><span class="va">dailyMid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">nDays</span><span class="op">)</span></span>
<span><span class="va">dailyHigh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">nDays</span><span class="op">)</span></span>
<span><span class="va">title</span> <span class="op">&lt;-</span> <span class="st">"South Fork Coeur d'Alene River near Pinehurst, ID\nCumulative Daily Total Phosphorus Flux\n90% Prediction Intervals"</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span> <span class="va">nDays</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">dailyBootSum</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.5</span>, <span class="fl">0.95</span><span class="op">)</span>, type <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span>  <span class="va">dailyLow</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">v</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">dailyMid</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">v</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">dailyHigh</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">v</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">dailyMid</span><span class="op">/</span><span class="fl">1000</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">yMax</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, main <span class="op">=</span> <span class="va">title</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Cumulative flux in metric tons"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span>, type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>     las <span class="op">=</span> <span class="fl">1</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">3</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">4</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">dailyLow</span><span class="op">/</span><span class="fl">1000</span>, type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">dailyHigh</span><span class="op">/</span><span class="fl">1000</span>, type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="prediction_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>All of these figures give some ideas of how one might utilize the
results that can come out of the <code>genBootDaily</code> function
(WRTDSKalman bootstrapping process). Of course and of these examples
could be used to produce tabular output rather than graphical. The
process for doing so should be pretty clear from following the code.</p>
<p>None of these kinds of analyses or graphics are currently in any
publications. Major testing of the accuracy of these results is
currently underway and showing very promising results. Verification of
these kind of results is not easy, because it isn’t just a matter of
saying how close did we get to the truth, but rather the question is,
over many applications of these methods how frequently was the truth
really outside the 90% prediction interval (and a host of similar
questions, evaluated at many time scales over many data sets). Having
said that, I think these methods are ready for people to put them to use
in quantifying the uncertainty of concentration and flux estimates.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer></footer>
</div> <!-- / div for your main content-->

<!-- BEGIN USGS Footer Template -->

<footer class="footer"><div class="tmp-container">
		<!-- .footer-wrap -->
			<!-- .footer-doi -->
			<div class="footer-doi">
				<!-- footer nav links -->
				<ul class="menu nav">
<li class="first leaf menu-links menu-level-1"><a href="https://www.doi.gov/privacy" class="external-link">DOI Privacy Policy</a></li>
					<li class="leaf menu-links menu-level-1"><a href="https://www.usgs.gov/policies-and-notices" class="external-link">Legal</a></li>
					<li class="leaf menu-links menu-level-1"><a href="https://www.usgs.gov/accessibility-and-us-geological-survey" class="external-link">Accessibility</a></li>
					<li class="leaf menu-links menu-level-1"><a href="https://www.usgs.gov/sitemap" class="external-link">Site Map</a></li>
					<li class="last leaf menu-links menu-level-1"><a href="https://answers.usgs.gov/" class="external-link">Contact USGS</a></li>
				</ul>
<!--/ footer nav links -->
</div>
			<!-- /.footer-doi -->

			<hr>
<!-- .footer-utl-links --><div class="footer-doi">
			<ul class="menu nav">
<li class="first leaf menu-links menu-level-1"><a href="https://www.doi.gov/" class="external-link">U.S. Department of the Interior</a></li>
				<li class="leaf menu-links menu-level-1"><a href="https://www.doioig.gov/" class="external-link">DOI Inspector General</a></li>
				<li class="leaf menu-links menu-level-1"><a href="https://www.whitehouse.gov/" class="external-link">White House</a></li>
				<li class="leaf menu-links menu-level-1"><a href="https://www.whitehouse.gov/omb/management/egov/" class="external-link">E-gov</a></li>
				<li class="leaf menu-links menu-level-1"><a href="https://www.doi.gov/pmb/eeo/no-fear-act" class="external-link">No Fear Act</a></li>
				<li class="last leaf menu-links menu-level-1"><a href="https://www.usgs.gov/about/organization/science-support/foia" class="external-link">FOIA</a></li>
			</ul>
</div>			
		<!-- /.footer-utl-links -->
		<!-- .footer-social-links -->
		<div class="footer-social-links">
			<ul class="social">
<li class="follow">Follow</li>
				<li class="twitter">
					<a href="https://twitter.com/usgs" target="_blank" class="external-link">
						<i class="fa fa-twitter-square"><span class="only">Twitter</span></i>
					</a>
				</li>
				<li class="facebook">
					<a href="https://facebook.com/usgeologicalsurvey" target="_blank" class="external-link">
						<i class="fa fa-facebook-square"><span class="only">Facebook</span></i>
					</a>
				</li>
				<li class="github">
					<a href="https://github.com/usgs" target="_blank" class="external-link">
						<i class="fa fa-github"><span class="only">GitHub</span></i>
					</a>
				</li>
				<li class="flickr">
					<a href="https://flickr.com/usgeologicalsurvey" target="_blank" class="external-link">
						<i class="fa fa-flickr"><span class="only">Flickr</span></i>
					</a>
				</li>
				<li class="youtube">
					<a href="http://youtube.com/usgs" target="_blank" class="external-link">
						<i class="fa fa-youtube-play"><span class="only">YouTube</span></i>
					</a>
				</li>
				<li class="instagram">
					<a href="https://instagram.com/usgs" target="_blank" class="external-link">
						<i class="fa fa-instagram"><span class="only">Instagram</span></i>
					</a>
				</li>
			</ul>
</div>
		<!-- /.footer-social-links -->
	</div>
		<!-- /.footer-wrap -->	
</footer><!-- END USGS Footer Template- --><!-- Google Tag Manager (noscript) --><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TKQR8KP" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
  
  </body>
<!-- closing div for body -->
</html>
